<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Support Direct - Assistance</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca;
            --bg-dark: #0f172a; --text-main: #1e293b;
            --text-muted: #64748b; --white: #ffffff; --system: #f1f5f9;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            font-family: 'Inter', sans-serif; background-color: var(--bg-dark); 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }

        .main-wrapper { 
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at top left, #4f46e522, transparent), 
                        radial-gradient(circle at bottom right, #7c3aed22, transparent);
        }

        .card { 
            width: 100%; height: 100%; max-width: 1200px; max-height: 900px; 
            background: var(--white); display: flex; flex-direction: column; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); overflow: hidden;
        }

        @media (max-width: 1024px) { .card { max-width: 100%; max-height: 100%; } }

        .screen { 
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            padding: 40px; text-align: center; animation: fadeIn 0.4s ease-out; 
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        .illustration { font-size: 60px; margin-bottom: 20px; }
        h2 { font-size: 28px; font-weight: 600; color: var(--text-main); margin: 0 0 10px; }
        p { font-size: 16px; color: var(--text-muted); max-width: 400px; line-height: 1.5; margin-bottom: 30px; }

        input.modern, select.modern { 
            width: 100%; max-width: 380px; padding: 16px 20px; border: 2px solid #f1f5f9; 
            border-radius: 15px; font-size: 16px; outline: none; transition: 0.3s; margin-bottom: 15px;
        }
        input.modern:focus, select.modern:focus { border-color: var(--primary); background: #fff; }

        .btn-main { 
            width: 100%; max-width: 380px; padding: 18px; background: var(--primary); 
            color: white; border: none; border-radius: 15px; font-size: 17px; font-weight: 600; 
            cursor: pointer; transition: 0.3s; 
        }
        .btn-main:hover:not(:disabled) { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-main:disabled { background: #cbd5e1; cursor: not-allowed; }

        /* HEADER CHAT */
        #chat-ui { height: 100%; display: flex; flex-direction: column; background: #fff; }
        .chat-header { 
            padding: 15px 25px; border-bottom: 1px solid #f1f5f9; 
            display: flex; align-items: center; justify-content: space-between;
        }
        .status-badge { display: flex; align-items: center; gap: 10px; }
        .dot { width: 10px; height: 10px; background: #cbd5e1; border-radius: 50%; }
        .dot.active { background: #10b981; box-shadow: 0 0 8px #10b981; }

        .header-actions { display: flex; align-items: center; gap: 10px; }
        .btn-end {
            background: #fee2e2; color: var(--danger); border: none;
            padding: 8px 12px; border-radius: 10px; font-size: 12px; font-weight: 700;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .btn-end:hover { background: var(--danger); color: white; }

        #chat-box { flex: 1; overflow-y: auto; padding: 25px; background: #f8fafc; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 75%; padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.4; word-wrap: break-word; }
        .me { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .other { align-self: flex-start; background: #fff; border: 1px solid #e2e8f0; border-bottom-left-radius: 4px; }
        .system { align-self: center; font-size: 12px; color: var(--text-muted); background: var(--system); padding: 5px 15px; border-radius: 20px; }

        .typing-info { font-size: 12px; color: var(--text-muted); height: 20px; padding: 5px 25px; font-style: italic; display: none; }
        
        .footer-input { padding: 20px 25px; border-top: 1px solid #f1f5f9; display: flex; gap: 12px; align-items: center; }
        .footer-input input { flex: 1; padding: 14px 20px; border: none; background: #f1f5f9; border-radius: 25px; font-size: 15px; outline: none; }

        .star { font-size: 45px; cursor: pointer; transition: 0.2s; }
        .star:hover { transform: scale(1.2); }
        .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center; z-index: 1000;
    animation: fadeIn 0.2s ease-out;
}

.modal-content {
    background: white; padding: 30px; border-radius: 24px; width: 90%; max-width: 400px;
    text-align: center; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2);
}

.modal-icon { font-size: 40px; margin-bottom: 15px; }

.modal-content h3 { margin: 0 0 10px; color: var(--text-main); font-size: 20px; }
.modal-content p { color: var(--text-muted); font-size: 15px; margin-bottom: 25px; }

.modal-buttons { display: flex; gap: 12px; }

.btn-modal {
    flex: 1; padding: 12px; border: none; border-radius: 12px;
    font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s;
}

.btn-modal.cancel { background: var(--system); color: var(--text-main); }
.btn-modal.confirm { background: var(--danger); color: white; }

.btn-modal:hover { opacity: 0.9; transform: translateY(-1px); }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="card">
        <div id="scr-cgu" class="screen">
            <div class="illustration">üõ°Ô∏è</div>
            <h2>Charte d'utilisation</h2>
            <div style="text-align: left; background: var(--system); padding: 15px; border-radius: 12px; margin-bottom: 10px; font-size: 14px; color: var(--text-main); max-width: 450px;">
                <p style="margin: 0 0 10px 0;">‚úÖ <b>Anonymat :</b> Ne communiquez pas votre nom de famille, email ou t√©l√©phone.</p>
                <p style="margin: 0 0 10px 0;">üìä <b>Donn√©es :</b> Vos √©changes sont conserv√©s par l'organisateur de l'√©v√©nement.</p>
                <p style="margin: 0;">üîû <b>Mineurs :</b> En continuant, vous confirmez avoir plus de 15 ans ou l'autorisation de vos parents.</p>
            </div>
            
            <p style="margin-bottom: 25px;">
                <a href="CGU.html" style="color: var(--primary); font-size: 13px; font-weight: 500; text-decoration: underline;">
                    Lire les conditions compl√®tes (CGU & RGPD)
                </a>
            </p>
        
            <button class="btn-main" onclick="initLoginScreen()">J'ai compris et j'accepte</button>
        </div>

        <div id="scr-login" class="screen hidden">
    <div class="illustration">üëã</div>
    <h2>Identification</h2>
    <input type="text" id="username" class="modern" placeholder="Choisissez un pseudo (ex: User123)" autocomplete="off">
    <p style="font-size: 12px; margin-top: -10px;">‚ö†Ô∏è N'utilisez pas v√¥tre nom de famille.</p>
    <select id="client-zone" class="modern"></select>
    <button class="btn-main" onclick="startSession()">D√©marrer la session</button>
</div>

        <div id="chat-ui" class="hidden">
            <div class="chat-header">
                <div class="status-badge">
                    <div id="status-dot" class="dot"></div>
                    <div>
                        <b id="op-name" style="display:block; font-size:15px;">Support</b>
                        <small id="status-txt" style="color:var(--text-muted)">Recherche de conseiller...</small>
                    </div>
                </div>
                <div class="header-actions">
                    <div id="active-zone-tag" style="font-size: 11px; background: var(--system); padding: 5px 12px; border-radius: 12px; color: var(--primary); font-weight: 600;"></div>
                   <button id="btn-report" class="btn-end" onclick="openReportModal()" style="display: none; background: #fff7ed; color: #ea580c; border: 1px solid #fdba74;" title="Signaler un probl√®me">
                     ‚ö†Ô∏è Signaler
                  </button>
                    <button class="btn-end" onclick="confirmEndChat()" title="Terminer le chat">‚úï Quitter</button>
                </div>
            </div>
            <div id="chat-box">
                
            </div>
            <div id="typing-indicator" class="typing-info">Le conseiller √©crit...</div>
            <div class="footer-input">
                <input type="text" id="msg-input" placeholder="Attente..." disabled onkeyup="handleKey(event)" oninput="emitTyping()">
                <button id="send-btn" class="btn-main" style="width:50px; height:50px; padding:0; border-radius:50%;" onclick="send()" disabled>‚û§</button>
            </div>
        </div>

        <div id="scr-rating" class="screen hidden">
            <div class="illustration">üéñÔ∏è</div>
            <h2>√âvaluez notre aide</h2>
            <p>Comment s'est pass√©e votre discussion ?</p>
            <div style="display:flex; gap:10px; margin: 20px 0;">
                <span class="star" onclick="submitRating(1)">‚≠ê</span>
                <span class="star" onclick="submitRating(2)">‚≠ê</span>
                <span class="star" onclick="submitRating(3)">‚≠ê</span>
                <span class="star" onclick="submitRating(4)">‚≠ê</span>
                <span class="star" onclick="submitRating(5)">‚≠ê</span>
            </div>
        </div>

        <div id="scr-thanks" class="screen hidden">
            <div class="illustration">‚úÖ</div>
            <h2>Merci pour votre retour</h2>
            <p>La session est ferm√©e.</p>
            <button class="btn-main" onclick="location.reload()">Nouvelle discussion</button>
        </div>
    </div>
</div>
<div id="custom-confirm" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h3 id="modal-title">Terminer la session ?</h3>
        <p id="modal-text">Cette action fermera d√©finitivement la discussion en cours.</p>
        <div class="modal-buttons">
            <button class="btn-modal cancel" onclick="closeModal()">Annuler</button>
            <button class="btn-modal confirm" id="modal-confirm-btn">Oui, quitter</button>
        </div>
    </div>
</div>
<div id="report-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-icon">üõ°Ô∏è</div>
        <h3>Signaler un comportement</h3>
        <p>Un probl√®me avec cet √©change ?<br>L'√©quipe de mod√©ration va intervenir.</p>
        
        <select id="report-reason" class="modern" style="margin-bottom: 15px;">
            <option value="inappropriate">Propos inappropri√©s</option>
            <option value="personal_data">Demande de donn√©es personnelles</option>
            <option value="harassment">Harc√®lement</option>
            <option value="other">Autre probl√®me</option>
        </select>

        <div class="modal-buttons">
            <button class="btn-modal cancel" onclick="closeReportModal()">Annuler</button>
            <button class="btn-modal confirm" onclick="submitReport()" style="background: #ea580c;">Envoyer l'alerte</button>
        </div>
    </div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
let socket, currentRoom, sessionId, myName, selectedZone, typingTimer;

window.onload = async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const zoneFromUrl = urlParams.get('zone'); 
    
    if (zoneFromUrl) {
        sessionStorage.setItem('chat_zone', zoneFromUrl);
        selectedZone = zoneFromUrl;
    }
    const savedToken = sessionStorage.getItem('chat_token');
    if (savedToken) {
        myName = sessionStorage.getItem('chat_name');
        selectedZone = sessionStorage.getItem('chat_zone');
        document.getElementById('scr-cgu').classList.add('hidden');
        document.getElementById('chat-ui').classList.remove('hidden');
        document.getElementById('active-zone-tag').innerText = "üìç " + selectedZone;
        connectSocket(savedToken);
    } else {
        await loadZones();
    }
};

function connectSocket(token) {
    socket = io({ auth: { token } });
    socket.on('connect', () => socket.emit('get_active_session', { name: myName }));
    socket.on('active_session_info', (data) => {
        if (data && data.sessionId) {
            sessionId = data.sessionId;
            currentRoom = data.room;
            enableChat();
            loadHistory(sessionId); 
        }
    });
    socket.emit('join_waiting_room', { zone: selectedZone });
    setupListeners();
}
function openReportModal() {
    document.getElementById('report-modal').classList.remove('hidden');
}

function closeReportModal() {
    document.getElementById('report-modal').classList.add('hidden');
}

function submitReport() {
    const reason = document.getElementById('report-reason').value;
    const zonePourSignalement = (typeof selectedZone !== 'undefined' && selectedZone) 
                                ? selectedZone 
                                : (sessionStorage.getItem('chat_zone') || "G√©n√©rale");
    if (socket && sessionId) {
        // On envoie le signalement au serveur
        socket.emit('report_issue', {
            sessionId: sessionId,
            room: currentRoom,
            reason: reason,
            zone: zonePourSignalement,
            timestamp: new Date().toISOString()
        });

        // Feedback visuel
        alert("Signalement envoy√©. Un mod√©rateur va v√©rifier la conversation.");
        closeReportModal();
        
        // Optionnel : On peut proposer de quitter le chat imm√©diatement apr√®s un signalement
        confirmEndChat();
    }
}

function setupListeners() {
    const box = document.getElementById('chat-box');
box.innerHTML = `<div class="system">üîí Rappel : Ne partagez aucune donn√©e personnelle (t√©l√©phone, adresse, nom).</div>`;
    socket.on('chat_started', d => {
        currentRoom = d.room; sessionId = d.sessionId;
        document.getElementById('op-name').innerText = d.operator;
        document.getElementById('status-txt').innerText = "En ligne";
        document.getElementById('status-dot').classList.add('active');
        document.getElementById('btn-report').style.display = 'flex';
        enableChat();
    });

    socket.on('disconnect', () => {
    document.getElementById('status-txt').innerText = "D√©connect√© - Reconnexion...";
    document.getElementById('status-dot').classList.remove('active');
    document.getElementById('msg-input').disabled = true;

    
});
socket.on('operator_changed', (data) => {
        console.log("Changement d'op√©rateur re√ßu :", data.newOperatorName);
        const nameEl = document.getElementById('op-name');
        if (nameEl) {
            nameEl.innerText = data.newOperatorName;
            // Petit flash visuel pour confirmer le changement
            nameEl.style.transition = "color 0.3s";
            nameEl.style.color = "#4f46e5"; 
            setTimeout(() => { nameEl.style.color = ""; }, 2000);
        }
    });

    socket.on('receive_message', d => {
        const box = document.getElementById('chat-box');
        const cls = d.isSystem ? 'system' : (d.sender === myName ? 'me' : 'other');
        box.innerHTML += `<div class="msg ${cls}">${d.content}</div>`;
        box.scrollTop = box.scrollHeight;
    });

    socket.on('is_typing', () => document.getElementById('typing-indicator').style.display = 'block');
    socket.on('is_not_typing', () => document.getElementById('typing-indicator').style.display = 'none');

    // D√©clench√© quand l'OP√âRATEUR termine le chat
    socket.on('request_rating', d => { 
        sessionId = d.sessionId; 
        endSessionUI();
    });
}

// FONCTION POUR QUITTER MANUELLEMENT
function confirmEndChat() {
    const isWaiting = !sessionId;
    const modal = document.getElementById('custom-confirm');
    const title = document.getElementById('modal-title');
    const text = document.getElementById('modal-text');
    const confirmBtn = document.getElementById('modal-confirm-btn');

    // Personnalisation du texte selon l'√©tat
    if (isWaiting) {
        title.innerText = "Annuler la demande ?";
        text.innerText = "Vous allez quitter la file d'attente.";
    } else {
        title.innerText = "Terminer la discussion ?";
        text.innerText = "Souhaitez-vous vraiment clore cet √©change avec le conseiller ?";
    }

    // On d√©finit l'action du bouton confirmer
    confirmBtn.onclick = () => {
        executeEndChat(isWaiting);
        closeModal();
    };

    modal.classList.remove('hidden');
}
function executeEndChat(isWaiting) {
    if (socket) {
        // On envoie le signal avant de couper
        socket.emit('client_leaving', { 
            room: currentRoom || null, 
            sessionId: sessionId || null 
        });
    }

    sessionStorage.clear();

    if (isWaiting) {
        location.reload(); 
    } else {
        endSessionUI();
    }
}

function closeModal() {
    document.getElementById('custom-confirm').classList.add('hidden');
}

function endSessionUI() {
    // Cache le chat et montre uniquement la notation
    document.getElementById('btn-report').style.display = 'none';
    document.getElementById('chat-ui').classList.add('hidden');
    document.getElementById('scr-rating').classList.remove('hidden');
}

function emitTyping() {
    if (!socket || !currentRoom) return;
    socket.emit('is_typing', { room: currentRoom });
    clearTimeout(typingTimer);
    typingTimer = setTimeout(() => {
        if(socket) socket.emit('is_not_typing', { room: currentRoom });
    }, 2000);
}

async function loadHistory(sId) {
    try {
        const res = await fetch(`/api/history-data/${sId}`);
        const msgs = await res.json();
        const box = document.getElementById('chat-box');
        box.innerHTML = msgs.map(m => {
            const cls = m.sender_name === myName ? 'me' : 'other';
            return `<div class="msg ${cls}">${m.content}</div>`;
        }).join('');
        box.scrollTop = box.scrollHeight;
    } catch(e) { console.error("Erreur historique", e); }
}

function send() {
    const input = document.getElementById('msg-input');
    if (input.value.trim() && currentRoom) {
        socket.emit('send_message', { message: input.value, room: currentRoom, sessionId });
        input.value = '';
        socket.emit('is_not_typing', { room: currentRoom });
    }
}

async function startSession() {
    myName = document.getElementById('username').value.trim();
    selectedZone = document.getElementById('client-zone').value;
    if (!myName) return alert("Veuillez entrer votre nom.");

    const res = await fetch('/api/login-user', { 
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: myName}) 
    });
    const { token } = await res.json();
    
    sessionStorage.setItem('chat_token', token);
    sessionStorage.setItem('chat_name', myName);
    sessionStorage.setItem('chat_zone', selectedZone);
    
    document.getElementById('active-zone-tag').innerText = "üìç " + selectedZone;
    changeScreen('scr-login', 'chat-ui');
    connectSocket(token);
}

function enableChat() {
    const inp = document.getElementById('msg-input');
    inp.disabled = false;
    inp.placeholder = "√âcrivez ici...";
    document.getElementById('send-btn').disabled = false;
}

function handleKey(e) { if(e.key === 'Enter') send(); }

function changeScreen(oldId, newId) {
    document.getElementById(oldId).classList.add('hidden');
    document.getElementById(newId).classList.remove('hidden');
}

function initLoginScreen() { changeScreen('scr-cgu', 'scr-login'); }

async function loadZones() {
    try {
        const res = await fetch('/api/zones');
        const zones = await res.json();
        const zoneSelect = document.getElementById('client-zone');
        
        // On remplit le select normalement
        zoneSelect.innerHTML = zones.map(z => `<option value="${z}">${z}</option>`).join('');

        // --- LOGIQUE DE CACHAGE ---
        const urlParams = new URLSearchParams(window.location.search);
        const zoneFromUrl = urlParams.get('zone');

        if (zoneFromUrl) {
            // On force la valeur interne
            zoneSelect.value = zoneFromUrl;
            selectedZone = zoneFromUrl;
            
            // On cache la box (le select) pour que l'utilisateur ne puisse pas la modifier
            zoneSelect.style.display = 'none';
            
            // OPTIONNEL : On peut ajouter un petit texte pour confirmer la zone
            zoneSelect.insertAdjacentHTML('afterend', `<p style="color:var(--primary); font-weight:600;">üìç Zone : ${zoneFromUrl}</p>`);
        }
    } catch(e) { console.error(e); }
}

async function submitRating(val) {
    if (sessionId) {
        await fetch('/api/rate-session', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ sessionId, rating: val }) 
        });
    }
    sessionStorage.clear(); 
    changeScreen('scr-rating', 'scr-thanks');
}
</script>
</body>
</html>