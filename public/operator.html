<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console Expert | Support Live</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand: #4f46e5;
            --sidebar-bg: #0f172a;
            --bg-app: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            margin: 0;
            display: flex;
            height: 100vh;
            background: var(--bg-app);
            overflow: hidden;
        }

        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 400px;
        }

        .login-card h2 {
            margin-top: 0;
            color: var(--text-main);
            font-weight: 700;
        }

        .login-card p {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            outline: none;
            transition: 0.2s;
        }

        .form-group input:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn-login {
            width: 100%;
            background: var(--brand);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-login:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        #login-error {
            color: var(--danger);
            font-size: 13px;
            margin-bottom: 15px;
            display: none;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            color: #fff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .op-profile {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: 0.2s;
        }

        .op-profile:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .section-title {
            padding: 20px 24px 10px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: #475569;
        }

        /* FILE ATTENTE AVEC ZONES */
        .q-item {
            margin: 0 16px 8px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .q-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .q-zone-badge {
            font-size: 9px;
            background: #334155;
            color: #cbd5e1;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .btn-pick {
            background: var(--brand);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }

        /* TABS AREA */
        .tabs-area {
            width: 260px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }

        .tab-item {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            position: relative;
            transition: 0.2s;
        }

        .tab-item:hover {
            background: #f1f5f9;
        }

        .tab-item.active {
            background: #fff;
            box-shadow: inset 4px 0 0 var(--brand);
        }

        .tab-name {
            font-weight: 600;
            font-size: 14px;
            display: block;
        }

        .tab-status {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .tab-zone-tag {
            font-size: 10px;
            color: var(--brand);
            font-weight: 700;
        }

        .close-tab {
            position: absolute;
            top: 18px;
            right: 15px;
            color: #cbd5e1;
            cursor: pointer;
        }

        /* BADGE POINT ROUGE */
        .unread-badge {
            position: absolute;
            top: 50%;
            right: 40px;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            background-color: var(--danger);
            border-radius: 50%;
            display: none;
            box-shadow: 0 0 5px rgba(239, 68, 68, 0.5);
        }

        /* CHAT WINDOW */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .chat-win {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-win.active {
            display: flex;
        }
#empty-state {
    margin: auto;
    text-align: center;
    color: var(--text-muted);
    display: flex; /* Utilisez flex pour le centrage */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    width: 100%;
}
        .chat-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .notes-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #f8fafc;
            font-size: 13px;
            outline: none;
        }

        .msg-list {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #fdfdff;
        }

        .msg {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
        }

        .msg-time {
            font-size: 9px;
            opacity: 0.6;
            margin-top: 4px;
            display: block;
            text-align: right;
        }

        .me {
            align-self: flex-end;
            background: var(--brand);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .me .msg-time {
            color: #e0e7ff;
        }

        .other {
            align-self: flex-start;
            background: #f1f5f9;
            color: var(--text-main);
            border-bottom-left-radius: 2px;
        }

        .system {
            align-self: center;
            font-size: 11px;
            color: var(--text-muted);
            background: #f1f5f9;
            padding: 4px 12px;
            border-radius: 20px;
            text-align: center;
        }

        .input-area {
            padding: 20px 25px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 15px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 18px;
            border-radius: 10px;
            border: 1px solid var(--border);
            outline: none;
        }

        .btn-send {
            background: var(--brand);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 10px;
            cursor: pointer;
        }

        .offline {
            color: var(--danger) !important;
            font-weight: 700;
        }

        .typing {
            color: var(--success) !important;
            font-style: italic;
        }

        #empty-state {
            margin: auto;
            text-align: center;
            color: var(--text-muted);
        }

        .q-time {
            font-size: 10px;
            color: #94a3b8;
        }

        .msg.history {
            opacity: 0.7;
            /* Plus l√©ger pour montrer que c'est le pass√© */
            border-left: 3px solid #cbd5e1;
            background: #f8fafc;
        }

        .history-divider {
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            margin: 15px 0;
            position: relative;
        }

        .history-divider::before {
            content: "";
            position: absolute;
            left: 0;
            top: 50%;
            width: 30%;
            height: 1px;
            background: #e2e8f0;
        }

        .history-divider::after {
            content: "";
            position: absolute;
            right: 0;
            top: 50%;
            width: 30%;
            height: 1px;
            background: #e2e8f0;
        }
        .tab-item.offline { opacity: 0.6; }
.chat-win.closed { filter: grayscale(0.5); pointer-events: none; }
    </style>
</head>

<body>
    <div id="custom-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div
            style="background:white; padding:30px; border-radius:12px; max-width:400px; width:90%; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1);">
            <h3 id="modal-title" style="margin-top:0;">Confirmation</h3>
            <p id="modal-text" style="color:var(--text-muted); font-size:14px; line-height:1.5;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:25px;">
                <button id="modal-cancel"
                    style="padding:10px 20px; border:1px solid var(--border); background:none; border-radius:8px; cursor:pointer;">Annuler</button>
                <button id="modal-confirm"
                    style="padding:10px 20px; background:var(--brand); color:white; border:none; border-radius:8px; cursor:pointer;">Accepter</button>
            </div>
        </div>
    </div>
    <div id="login-overlay">
        <div class="login-card">
            <h2>Acc√®s Expert</h2>
            <p>Connectez-vous pour g√©rer le support live.</p>
            <div id="login-error">Identifiants incorrects.</div>
            <div class="form-group">
                <label>Nom d'utilisateur</label>
                <input type="text" id="login-u" placeholder="ex: admin">
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="login-p" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn-login" onclick="handleLogin()">Connexion</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="op-profile" style="cursor: default;">
            <div style="font-size: 10px; opacity: 0.5; margin-bottom: 4px; text-transform: uppercase;">Mon Profil</div>
            <b id="op-display-name">Chargement...</b><br>
            <small id="op-username" style="opacity: 0.5"></small>
        </div>
        <div class="section-title">File d'attente</div>
        <div id="q-list"></div>
        <div class="section-title">Raccourcis <button onclick="addShortcut()"
                style="float:right; background:none; border:none; color:var(--brand); cursor:pointer; font-weight:bold;">+</button>
        </div>
        <div id="shortcuts-list" style="padding: 0 16px;"></div>
    </div>

    <div class="tabs-area" id="tabs-list">
        <div class="section-title" style="padding-left: 20px;">Conversations</div>
    </div>

    <div class="chat-container" id="chat-container">
        <div id="empty-state">
            <div style="font-size: 50px; opacity: 0.2;">üéß</div>
            <h2>Console Support</h2>
            <p>En attente d'un client...</p>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket, myToken, myLogin, typingTimer;
        let sessions = {};
        let shortcuts = JSON.parse(localStorage.getItem('my_shortcuts')) || {
            '/bjr': 'Bonjour, comment puis-je vous aider ?'
        };

        // Sons avec timeout pour √©viter le blocage
        const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');
        const queueSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        // Pr√©chargement des sons de mani√®re asynchrone
        notificationSound.preload = 'auto';
        queueSound.preload = 'auto';

        let isWindowFocused = true;
        window.onfocus = () => {
            isWindowFocused = true;
            document.title = "Console Support";
        };
        window.onblur = () => {
            isWindowFocused = false;
        };

        function notifyExpert(msg) {
            if (!isWindowFocused) {
                let blink = true;
                const interval = setInterval(() => {
                    document.title = blink ? "üîî NOUVEAU MESSAGE" : "Console Support";
                    blink = !blink;
                    if (isWindowFocused) {
                        clearInterval(interval);
                        document.title = "Console Support";
                    }
                }, 1000);
            }
        }

        function playSound(audio) {
            try {
                const playPromise = audio.play();
                if (playPromise) {
                    playPromise.catch(e => console.log('Son bloqu√© par le navigateur'));
                }
            } catch (e) {}
        }
        let lastQueueCount = 0;

        function getNow() {
            return new Date().toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        document.getElementById('login-p').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        async function handleLogin() {
            const u = document.getElementById('login-u').value;
            const p = document.getElementById('login-p').value;
            const errorDiv = document.getElementById('login-error');
            const res = await fetch('/api/login-operator', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: u,
                    password: p
                })
            });
            const data = await res.json();
            if (data.token) {
                myToken = data.token;
                document.getElementById('login-overlay').style.display = 'none';
                completeInit();
            } else {
                errorDiv.style.display = 'block';
            }
        }

        async function completeInit() {
            const payload = JSON.parse(atob(myToken.split('.')[1]));
            myLogin = payload.login;

            // Setup socket IMM√âDIATEMENT (non bloquant)
            setupSocket();
            renderShortcuts();

            // Chargement du profil en arri√®re-plan
            loadOperatorProfile();
            updateOperatorList();
        }

        function showModal(title, text, onConfirm) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            modal.style.display = 'flex';

            document.getElementById('modal-confirm').onclick = () => {
                onConfirm();
                modal.style.display = 'none';
            };
            document.getElementById('modal-cancel').onclick = () => {
                modal.style.display = 'none';
            };
        }

        async function loadOperatorProfile() {
            try {
                const res = await fetch('/api/admin/operators');
                const ops = await res.json();
                const me = ops.find(o => o.username.toLowerCase() === myLogin.toLowerCase());

                if (me) {
                    document.getElementById('op-display-name').innerText = me.name;
                    document.getElementById('op-username').innerText = "@" + me.username;

                    // Mise √† jour du nom sur le socket une fois charg√©
                    if (socket && socket.connected) {
                        socket.emit('update_op_name', {
                            newName: me.name
                        });
                    }
                }
            } catch (e) {
                console.error("Erreur de chargement du profil:", e);
                // Fallback sur le login
                document.getElementById('op-display-name').innerText = myLogin;
                document.getElementById('op-username').innerText = "@" + myLogin;
            }
        }

        async function changeName() {
            const currentName = document.getElementById('op-display-name').innerText;
            const newName = prompt("Choisissez votre nom d'affichage :", currentName);

            if (newName && newName.trim() !== "" && newName !== currentName) {
                try {
                    // 1. Enregistrement en base de donn√©es
                    const res = await fetch('/api/admin/operators/update-name', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: myLogin,
                            newDisplayName: newName
                        })
                    });

                    if (res.ok) {
                        // 2. Mise √† jour UI
                        document.getElementById('op-display-name').innerText = newName;
                        localStorage.setItem('custom_op_name', newName);

                        // 3. Information en temps r√©el au serveur pour les transferts
                        if (socket) socket.emit('update_op_name', {
                            newName: newName
                        });

                        alert("Nom mis √† jour avec succ√®s !");
                    }
                } catch (e) {
                    alert("Erreur lors de l'enregistrement du nom.");
                }
            }
        }
        let isSocketSetup = false; // Flag pour √©viter de setup le socket plusieurs fois

        function setupSocket() {
            if (isSocketSetup) return; // √âviter la re-cr√©ation

            socket = io({
                auth: {
                    token: myToken
                },
                reconnection: true, // Reconnexion automatique activ√©e
                reconnectionAttempts: 5, // R√©duit √† 5 tentatives
                reconnectionDelay: 1000, // R√©duit √† 1 seconde
                timeout: 10000 // Timeout de connexion √† 10s
            });

            isSocketSetup = true;
            setupSocketEvents();
        }

        function switchChat(rid) {
            // 1. Cacher l'√©tat vide
            const emptyState = document.getElementById('empty-state');
            if (emptyState) emptyState.style.display = 'none';

            // 2. D√©sactiver tous les autres onglets et fen√™tres
            document.querySelectorAll('.tab-item, .chat-win').forEach(e => e.classList.remove('active'));

            // 3. Activer la fen√™tre demand√©e
            const currentTab = document.getElementById(`tab-${rid}`);
            const currentWin = document.getElementById(`win-${rid}`);
            
            if (currentTab) currentTab.classList.add('active');
            if (currentWin) currentWin.classList.add('active');

            // --- R√âINITIALISATION DU BADGE ---
            const badge = document.getElementById(`badge-${rid}`);
            if (badge) {
                badge.style.display = 'none'; // On cache le rond rouge au clic
            }

            const input = document.getElementById(`in-${rid}`);
            if (input) input.focus();
}
function setupSocketEvents() {
            socket.on('connect', () => {
                console.log('‚úÖ Connect√© au serveur');
                document.getElementById('op-display-name').style.color = '';
                const currentName = document.getElementById('op-display-name').innerText;
                if (currentName !== 'Chargement...') {
                    socket.emit('update_op_name', { newName: currentName });
                }
            });

            // GESTION DE LA RECONNEXION (Pour ne pas perdre la socket)
            socket.on('reconnect_attempt', (attempt) => {
                console.log('üîÑ Tentative de reconnexion n¬∞', attempt);
                document.getElementById('op-display-name').style.color = 'orange';
            });

            socket.on('reconnect', () => {
                console.log('‚ú® Reconnexion r√©ussie');
                updateOperatorList();
            });

            socket.on('disconnect', () => {
                document.getElementById('op-display-name').style.color = 'var(--danger)';
            });

            // NOUVEAU : Fermeture auto si le client quitte ou se d√©connecte
            socket.on('close_chat_window', (data) => {
                const rid = data.room;
                const st = document.getElementById(`status-${rid}`);
                if (st) {
                    st.innerText = "S√âANCE TERMIN√âE";
                    st.className = "tab-status offline";
                }
                const input = document.getElementById(`in-${rid}`);
                if (input) {
                    input.disabled = true;
                    input.placeholder = "Le client a quitt√©.";
                }
                // Optionnel : on ferme l'onglet automatiquement apr√®s 10 secondes
                setTimeout(() => { if(sessions[rid]) release(rid, true); }, 10000);
            });

            socket.on('chat_history_recap', (data) => {
                const rid = data.room;
                setTimeout(() => {
                    const finalBox = document.getElementById(`box-${rid}`);
                    if (finalBox) {
                        let historyHtml = '<div class="history-divider">Historique</div>';
                        data.messages.forEach(m => {
                            const side = m.is_operator ? 'me' : 'other';
                            historyHtml += `<div class="msg ${side} history"><b>${m.sender_name}:</b> ${m.content}</div>`;
                        });
                        finalBox.innerHTML = historyHtml + '<div class="history-divider">Direct</div>';
                        finalBox.scrollTop = finalBox.scrollHeight;
                    }
                }, 100);
            });

            socket.on('update_queue', q => {
                if (q.length > lastQueueCount) playSound(queueSound);
                lastQueueCount = q.length;
                document.getElementById('q-list').innerHTML = q.map(c => `
                <div class="q-item">
                    <div class="q-info">
                        <span style="color:white; font-weight:500;">${c.name}</span>
                        <span class="q-zone-badge">${c.zone}</span>
                    </div>
                    <button class="btn-pick" onclick="pick('${c.id}', '${c.name}', null, '${c.zone}')">R√©pondre</button>
                </div>`).join('');
            });

            socket.on('receive_message', d => {
                const box = document.getElementById(`box-${d.room}`);
                if (box) {
                    const currentOpName = document.getElementById('op-display-name').innerText;
                    const isMe = d.sender === currentOpName;
                    const cls = d.isSystem ? 'system' : (isMe ? 'me' : 'other');
                    box.innerHTML += `<div class="msg ${cls}">${d.content}<span class="msg-time">${getNow()}</span></div>`;
                    box.scrollTop = box.scrollHeight;
                    if (!isMe && !d.isSystem) {
                        playSound(notificationSound);
                        notifyExpert(d.content);
                    }
                }
            });

            socket.on('is_typing', (data) => {
                const st = document.getElementById(`status-room_${data.senderId}`);
                if (st) { st.innerText = "√©crit..."; st.classList.add('typing'); }
            });

            socket.on('is_not_typing', (data) => {
                const st = document.getElementById(`status-room_${data.senderId}`);
                if (st) { st.innerText = "En ligne"; st.classList.remove('typing'); }
            });

            socket.on('transfer_request', data => {
                playSound(notificationSound);
                showModal("Transfert", `Reprendre ${data.clientName} ?`, () => {
                socket.emit('accept_transfer', { 
                    room: data.room, 
                    sessionId: data.sessionId  // Assurez-vous que data.sessionId contient l'UUID
                }); 
                   pick(data.room.replace('room_', ''), data.clientName, data.sessionId, data.zone);
                });
            });
        }
        function handleTyping(rid) {
            // On envoie 'is_typing' pour correspondre au serveur
            socket.emit('is_typing', {
                room: rid
            });
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                socket.emit('is_not_typing', {
                    room: rid
                });
            }, 1500);
        }

        function pick(cid, name, existingSid = null, zone = "G√©n√©ral") {
            const rid = `room_${cid}`;
            if (!sessions[rid]) {
                sessions[rid] = {
                    name,
                    cid,
                    sid: existingSid,
                    zone
                };

                // --- CR√âATION DU TAB ---
                const tab = document.createElement('div');
                tab.id = `tab-${rid}`;
                tab.className = 'tab-item';
                tab.innerHTML = `
            <span class="tab-zone-tag">üìç ${zone}</span>
            <span class="tab-name">${name}</span>
            <span class="tab-status" id="status-${rid}">En ligne</span>
            <div class="unread-badge" id="badge-${rid}"></div>
            <span class="close-tab" onclick="event.stopPropagation(); release('${rid}')">√ó</span>`;
                tab.onclick = () => switchChat(rid);
                document.getElementById('tabs-list').appendChild(tab);

                // --- CR√âATION DE LA WINDOW ---
                const win = document.createElement('div');
                win.id = `win-${rid}`;
                win.className = 'chat-win';
                win.innerHTML = `
            <div class="chat-header">
                <div style="display:flex; flex-direction:column; gap:2px; min-width:120px;">
                    <span style="font-size:12px; font-weight:700;">${name}</span>
                    <span style="font-size:10px; color:var(--brand); font-weight:600;">${zone}</span>
                </div>
                <input type="text" class="notes-input" id="note-${rid}" placeholder="Note dossier..." onblur="saveNote('${rid}')">
                <select id="tsel-${rid}" style="font-size:11px; border-radius:5px; border:1px solid #ddd;" onfocus="updateOperatorList('${rid}')">
                    <option value="">Chargement...</option>
                </select>
                <button class="btn-pick" onclick="transfer('${rid}')" style="background:var(--success)">OK</button>
            </div>
            <div class="msg-list" id="box-${rid}"></div>
            <div class="input-area">
                <input type="text" id="in-${rid}" placeholder="R√©pondre..." onkeypress="if(event.key==='Enter') send('${rid}')" oninput="handleTyping('${rid}')">
                <button class="btn-send" onclick="send('${rid}')">‚û§</button>
            </div>`;
                document.getElementById('chat-container').appendChild(win);

                // --- R√âCUP√âRATION SESSION ---
                if (!existingSid) {
                    socket.emit('pick_client', cid);
                    // On √©coute une seule fois pour lier le SID
                    socket.once('chat_started', d => {
                        if (d.room === rid) sessions[rid].sid = d.sessionId;
                    });
                }

                updateOperatorList();
            }
            switchChat(rid);
        }

        function send(rid) {
            const input = document.getElementById(`in-${rid}`);
            const text = input.value.trim();
            if (!text) return;

            let message = text;
            for (let k in shortcuts) {
                if (text.toLowerCase() === k.toLowerCase()) message = shortcuts[k];
            }

            socket.emit('send_message', {
                room: rid,
                message: message,
                sessionId: sessions[rid].sid
            });
            input.value = '';
            socket.emit('is_not_typing', { room: rid });
        }

        async function saveNote(rid) {
            const sid = sessions[rid]?.sid;
            const note = document.getElementById(`note-${rid}`).value;
            if (sid) {
                fetch('/api/update-notes', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId: sid, note })
                });
            }
        }

        
        function release(rid, auto = false) {
            const action = () => {
                const session = sessions[rid];
                if (session && session.sid) {
                    // CRUCIAL : On envoie le SID et le RID au serveur
                    socket.emit('finish_session', { 
                        sessionId: session.sid, 
                        roomId: rid 
                    });
                }

                // Nettoyage de l'interface expert
                document.getElementById(`tab-${rid}`)?.remove();
                document.getElementById(`win-${rid}`)?.remove();
                delete sessions[rid];

                if (Object.keys(sessions).length === 0) {
                    document.getElementById('empty-state').style.display = 'flex';
                }
            };

            if (auto) action();
            else showModal("Terminer", "Clore la discussion et demander une note ?", action);
        }
             

function transfer(rid) {
    const selectEl = document.getElementById(`tsel-${rid}`);
    const targetLogin = selectEl.value;
    const targetName = selectEl.options[selectEl.selectedIndex].text;

    if (!targetLogin) return alert("Veuillez choisir un expert.");

    showModal(
        "Confirmer le transfert",
        `Voulez-vous envoyer ce client √† ${targetName} ?`,
        () => {
            // 1. On demande le transfert au serveur
            socket.emit('transfer_chat', {
                sessionId: sessions[rid].sid,
                room: rid,
                newOperatorLogin: targetLogin,
                clientName: sessions[rid].name,
                zone: sessions[rid].zone
            });

            // 2. IMPORTANT : On ferme UNIQUEMENT la fen√™tre de l'expert A
            // On ne doit PAS envoyer 'finish_session' ici !
            const tab = document.getElementById(`tab-${rid}`);
            const win = document.getElementById(`win-${rid}`);
            if (tab) tab.remove();
            if (win) win.remove();
            delete sessions[rid];

            // On affiche l'√©tat vide si plus de chats
            if (Object.keys(sessions).length === 0) {
                document.getElementById('empty-state').style.display = 'flex';
            }
        }
    );
}


function copyShortcut(k) { alert("Tapez " + k + " dans le chat pour l'utiliser."); }
        function setupSocketEvents() {
            socket.on('connect', () => {
                console.log('‚úÖ Connect√© au serveur');
                document.getElementById('op-display-name').style.color = '';
                const currentName = document.getElementById('op-display-name').innerText;
                if (currentName !== 'Chargement...') {
                    socket.emit('update_op_name', { newName: currentName });
                }
            });

            // GESTION DE LA RECONNEXION (Pour ne pas perdre la socket)
            socket.on('reconnect_attempt', (attempt) => {
                console.log('üîÑ Tentative de reconnexion n¬∞', attempt);
                document.getElementById('op-display-name').style.color = 'orange';
            });

            socket.on('reconnect', () => {
                console.log('‚ú® Reconnexion r√©ussie');
                updateOperatorList();
            });

            socket.on('disconnect', () => {
                document.getElementById('op-display-name').style.color = 'var(--danger)';
            });

            // NOUVEAU : Fermeture auto si le client quitte ou se d√©connecte
            socket.on('close_chat_window', (data) => {
                const rid = data.room;
                const st = document.getElementById(`status-${rid}`);
                if (st) {
                    st.innerText = "S√âANCE TERMIN√âE";
                    st.className = "tab-status offline";
                }
                const input = document.getElementById(`in-${rid}`);
                if (input) {
                    input.disabled = true;
                    input.placeholder = "Le client a quitt√©.";
                }
                // Optionnel : on ferme l'onglet automatiquement apr√®s 10 secondes
                setTimeout(() => { if(sessions[rid]) release(rid, true); }, 10000);
            });

            socket.on('chat_history_recap', (data) => {
                const rid = data.room;
                setTimeout(() => {
                    const finalBox = document.getElementById(`box-${rid}`);
                    if (finalBox) {
                        let historyHtml = '<div class="history-divider">Historique</div>';
                        data.messages.forEach(m => {
                            const side = m.is_operator ? 'me' : 'other';
                            historyHtml += `<div class="msg ${side} history"><b>${m.sender_name}:</b> ${m.content}</div>`;
                        });
                        finalBox.innerHTML = historyHtml + '<div class="history-divider">Direct</div>';
                        finalBox.scrollTop = finalBox.scrollHeight;
                    }
                }, 100);
            });

            socket.on('update_queue', q => {
                if (q.length > lastQueueCount) playSound(queueSound);
                lastQueueCount = q.length;
                document.getElementById('q-list').innerHTML = q.map(c => `
                <div class="q-item">
                    <div class="q-info">
                        <span style="color:white; font-weight:500;">${c.name}</span>
                        <span class="q-zone-badge">${c.zone}</span>
                    </div>
                    <button class="btn-pick" onclick="pick('${c.id}', '${c.name}', null, '${c.zone}')">R√©pondre</button>
                </div>`).join('');
            });

            socket.on('receive_message', d => {
                const rid = d.room;
                const box = document.getElementById(`box-${rid}`);
                
                if (box) {
                    const currentOpName = document.getElementById('op-display-name').innerText;
                    const isMe = d.sender === currentOpName;
                    const cls = d.isSystem ? 'system' : (isMe ? 'me' : 'other');
                    
                    // Ajout du message dans la bo√Æte
                    box.innerHTML += `<div class="msg ${cls}">${d.content}<span class="msg-time">${getNow()}</span></div>`;
                    box.scrollTop = box.scrollHeight;

                    if (!isMe && !d.isSystem) {
                        playSound(notificationSound);
                        notifyExpert(d.content);

                        // --- LOGIQUE DU ROND ROUGE ---
                        const currentWin = document.getElementById(`win-${rid}`);
                        // Si la fen√™tre n'est pas affich√©e (pas la classe 'active')
                        if (currentWin && !currentWin.classList.contains('active')) {
                            const badge = document.getElementById(`badge-${rid}`);
                            if (badge) {
                                badge.style.display = 'block'; // On montre le rond rouge
                            }
                        }
                    }
                }
            });

            socket.on('is_typing', (data) => {
                const st = document.getElementById(`status-room_${data.senderId}`);
                if (st) { st.innerText = "√©crit..."; st.classList.add('typing'); }
            });

            socket.on('is_not_typing', (data) => {
                const st = document.getElementById(`status-room_${data.senderId}`);
                if (st) { st.innerText = "En ligne"; st.classList.remove('typing'); }
            });

            socket.on('transfer_request', data => {
                playSound(notificationSound);
                showModal("Transfert", `Reprendre ${data.clientName} ?`, () => {
                    socket.emit('accept_transfer', { 
                        room: data.room, 
                        sessionId: data.sessionId  // Assurez-vous que data.sessionId contient l'UUID
                    });
                    pick(data.room.replace('room_', ''), data.clientName, data.sessionId, data.zone);
                });
            });
        }
        function closeUI(rid) {
            const t = document.getElementById(`tab-${rid}`);
            const w = document.getElementById(`win-${rid}`);
            if (t) t.remove();
            if (w) w.remove();
            delete sessions[rid];
            if (Object.keys(sessions).length === 0) document.getElementById('empty-state').style.display = 'block';
        }

        async function updateOperatorList(rid = null) {
    try {
        const res = await fetch('/api/operators-online');
        if (!res.ok) throw new Error("Erreur r√©seau");
        const ops = await res.json();
        
        // On filtre pour ne pas se voir soi-m√™me dans la liste
        const otherOps = ops.filter(o => o.login && o.login !== myLogin);
        
        // On cible soit un s√©lecteur pr√©cis, soit tous les s√©lecteurs de fen√™tres actives
        const selectors = rid ? 
            [document.getElementById(`tsel-${rid}`)] : 
            document.querySelectorAll('select[id^="tsel-"]');

        selectors.forEach(sel => {
            if (!sel) return;
            
            // On m√©morise la s√©lection en cours pour ne pas la perdre
            const currentValue = sel.value;
            
            let html = '<option value="">Transf√©rer √†...</option>';
            html += otherOps.map(o => {
                const isSelected = o.login === currentValue ? 'selected' : '';
                return `<option value="${o.login}" ${isSelected}>${o.name}</option>`;
            }).join('');
            
            sel.innerHTML = html;
        });
    } catch (e) {
        console.error("Erreur lors de la mise √† jour de la liste des experts:", e);
    }
}

        function renderShortcuts() {
            const list = document.getElementById('shortcuts-list');
            list.innerHTML = Object.entries(shortcuts).map(([k, v]) => `
            <div style="font-size:12px; padding:8px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:5px; display:flex; justify-content:space-between; color:white;">
                <b>${k}</b> <span onclick="deleteShortcut('${k}')" style="cursor:pointer; color:var(--danger)">√ó</span>
            </div>`).join('');
            localStorage.setItem('my_shortcuts', JSON.stringify(shortcuts));
        }

        function addShortcut() {
            const k = prompt("Code (ex: /bjr)"),
                v = prompt("Message :");
            if (k && v) {
                shortcuts[k] = v;
                renderShortcuts();
            }
        }

        function deleteShortcut(k) {
            delete shortcuts[k];
            renderShortcuts();
        }
    </script>
</body>

</html>